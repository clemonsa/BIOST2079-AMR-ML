---
title: "Random Forest AMR Prediction"
author: "Arvon Clemons"
date: "9/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r warning = FALSE, message=FALSE, echo=FALSE}
#install packages only if you have not already done so 
list.of.packages <- c("randomForest", "ggplot2", "dplyr", "caret",
                      "readr", "e1071", "mlbench", "slam","parallel", "doParallel")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#library packages
for (pkg in c("randomForest", "ggplot2", "dplyr",
              "caret", "readr","parallel", "doParallel")) {
  library(pkg, character.only = TRUE)
  }
```

# Function to create Training and Test datasets
```{r}
datasetsRF <- function(csvname, seed=05101929, percent=0.7){
  stopifnot(is.character(csvname))
  
  '%>%' <- tidyr::'%>%'
  
#Import dataset
rfData <- readr::read_csv(csvname, col_types = readr::cols(.default = readr::col_factor(NULL))) %>% 
  dplyr::select_if(sapply(., nlevels) > 1)
#Split
set.seed(seed)
index <- dplyr::select(rfData,dplyr::matches(stringr::str_extract(unlist(stringr::str_split(csvname, "_"))[2],"^[[:alpha:]]+"))) %>% 
  unlist() %>% 
  caret::createDataPartition(times = 1, p = percent, list = FALSE)

dfTrain <- rfData %>% dplyr::slice(index) #training dataset
dfTest <- rfData %>% dplyr::slice(-index) #testing dataset

#return datasets
dataSets <- list(training = dfTrain, testing = dfTest)
invisible(dataSets)
}

#Example of using datasetsRF()
azm <- datasetsRF("./unitigs_azm.csv")
```

# Function to Train and Fit Random Forest Model (USE CAUTION)!!!
```{r}
trainRF <- function(training, y, seed=05101929, workers = 2, number=10){
trCtrl <- caret::trainControl("cv", number = number, #cross-validation
                       allowParallel = TRUE) #parallelization

cl <- parallel::makePSOCKcluster(workers) #set number of cores
doParallel::registerDoParallel(cl)
set.seed(seed)

#training and fitting model
system.time(
  modelRF <- train(
    paste0(y,"~",.), data=training, method="parRF",
    trControl = trCtrl,
    importance = T
  )
)
doParallel::stopCluster(cl)



invisible(modelRF)
}

# saveRDS(modelRF, file = "mockRF_model") #save RF model

```

# Import and Split Data
```{r}
#Import
## May require using "data_clean_script.R" to create "unitigs_cip.csv" in local directory
cipData <- read_csv("./unitigs_cip.csv", col_types = cols(.default = col_factor(NULL))) %>% 
  select_if(sapply(., nlevels) > 1)
#Split
set.seed(05101929)
index <- cipData$cip_sr %>% 
  createDataPartition(times = 1, p = 0.7, list = FALSE)

cipTrain <- cipData %>% slice(index)
cipTest <- cipData %>% slice(-index)
```

# Practice Model Training and Fit
```{r}
miniData <- cipData[1:1200, ] #subset to first 1200 observations
index2 <- miniData$cip_sr %>% 
  createDataPartition(times = 1, p = 0.8, list = FALSE)

miniTrain <- miniData %>% slice(index2) #train subset
miniTest <- miniData %>% slice(-index2) #test subset

trCtrl <- trainControl("cv", number = 10, #cross-validation
                       allowParallel = TRUE) #parallelization

# cl <- makePSOCKcluster(6) #set number of cores
# registerDoParallel(cl)
# set.seed(05101929)
# 
# system.time(
#   pracRF <- train(
#     cip_sr~., data=miniTrain, method="parRF",
#     trControl = trCtrl,
#     importance = T
#   )
# )
# stopCluster(cl)


saveRDS(pracRF, file = "mockRF_model") #save mock model
predictedAR <- pracRF %>% predict(miniTest) #mock predictions
mean(predictedAR == miniTest$cip_sr) #assess mock model accuracy
#[1] 0.9958159

predictedAR2 <- pracRF %>% predict(cipTest) #mock predictions on full dataset
mean(predictedAR == cipTest$cip_sr) #assess mock model accuracy on full dataset
#[1] 0.9773218
```

# Full Model Training and Fit (DO NOT RUN!!!!)
```{r}
trCtrl <- trainControl("cv", number = 10, #cross-validation
                       allowParallel = TRUE) #parallelization

# Select Cores for Parallelization
cl <- makePSOCKcluster(8) #set number of cores
registerDoParallel(cl)
set.seed(05101929)

# #Model Fit
# system.time(
# modelRF <- train(
#   cip_sr~., data = cipTrain, method = "parRF",
#   trControl = trCtrl,
#   importance = TRUE
#   )
# )
# After fitting model
stopCluster(cl)

saveRDS(modelRF, file = "fullRF_model") #save full model
predictedAR <- modelRF %>% predict(cipTest) #full predictions
mean(predictedAR == cipTest$cip_sr) #assess full model accuracy

# Best tuning parameter
modelRF$bestTune
```
